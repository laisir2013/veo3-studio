# VEO3 Studio - 旁白腳本編輯功能整合測試計劃

## 功能概述

本次實作的新功能允許使用者在生成影片前，對 AI 生成的旁白腳本進行審查、編輯和重新生成。

## 測試範圍

### 1. 後端 API 測試

#### 1.1 `regenerateNarration` 路由測試

**測試場景 1：成功重新生成旁白**
- 輸入：
  - taskId: 有效的任務 ID
  - sceneId: 場景編號
  - story: 故事文本
  - sceneDescription: 場景描述
  - existingNarration: 現有旁白
  - llmModel: 使用的 LLM 模型
  - language: 語言設定
- 預期輸出：
  - success: true
  - narrationSegments: 包含新生成的旁白片段陣列
  - 每個片段包含 segmentId 和 text

**測試場景 2：LLM 模型失敗，自動切換備用模型**
- 輸入：同上
- 預期行為：
  - 主模型失敗時自動嘗試備用模型
  - 最終返回成功結果或錯誤信息

**測試場景 3：所有模型都失敗**
- 輸入：同上
- 預期輸出：
  - success: false
  - error: 錯誤信息

#### 1.2 `analyzeStory` 函數測試

**測試場景 1：成功分析故事並生成分段旁白**
- 輸入：
  - story: 故事文本
  - characterDescription: 角色描述（可選）
  - visualStyle: 視覺風格（可選）
  - llmModel: 使用的 LLM 模型
  - language: 語言設定
- 預期輸出：
  - scenes: 場景陣列
  - 每個場景包含：
    - id: 場景編號
    - description: 場景描述（英文）
    - narrationSegments: 旁白片段陣列
    - imagePrompt: 圖片提示詞（英文）
  - characterPrompt: 角色基礎圖片提示詞

**測試場景 2：旁白片段驗證**
- 驗證每個旁白片段：
  - 長度在 30-50 個中文字之間
  - 使用正確的語言（廣東話/普通話/英文）
  - 內容與場景描述匹配

### 2. 前端組件測試

#### 2.1 `NarrationScriptEditor` 組件測試

**測試場景 1：組件初始化**
- 輸入：
  - sceneId: 1
  - taskId: "test-task-123"
  - story: "測試故事"
  - sceneDescription: "測試場景描述"
  - narrationSegments: 包含 2-3 個片段的陣列
  - llmModel: "gpt-4.1-mini"
  - language: "cantonese"
- 預期行為：
  - 組件正確渲染所有旁白片段
  - 顯示正確的片段計數和總字數
  - 編輯按鈕可用

**測試場景 2：編輯旁白**
- 操作：
  1. 點擊「編輯旁白」按鈕
  2. 修改某個片段的文字
  3. 驗證字數提示（應顯示「✓ 字數符合要求」或警告）
  4. 點擊「保存編輯」按鈕
- 預期行為：
  - 編輯界面正確顯示
  - 字數驗證正常工作
  - onNarrationUpdate 回調被觸發
  - 顯示成功提示信息

**測試場景 3：字數驗證**
- 操作：
  1. 編輯片段文字
  2. 輸入少於 20 字的文本
  3. 驗證警告信息
  4. 嘗試保存（應被阻止）
- 預期行為：
  - 顯示「⚠️ 至少需要 20 字」警告
  - 保存按鈕被禁用或保存失敗

**測試場景 4：AI 重新生成旁白**
- 操作：
  1. 點擊「AI 重新生成」按鈕
  2. 等待 API 響應
- 預期行為：
  - 按鈕顯示加載狀態
  - API 調用成功後，旁白片段被更新
  - onRegenerateNarration 回調被觸發
  - 顯示成功提示信息

**測試場景 5：播放旁白音頻**
- 操作：
  1. 點擊片段旁的音量圖標
  2. 等待 TTS 生成
- 預期行為：
  - 按鈕顯示加載狀態
  - 音頻生成後自動播放
  - 播放完成後狀態恢復

#### 2.2 前端集成測試

**測試場景 1：完整工作流程**
- 操作流程：
  1. 輸入故事文本
  2. 點擊「開始生成」
  3. 等待故事分析完成
  4. 驗證旁白編輯器顯示
  5. 編輯旁白
  6. 保存編輯
  7. 點擊「開始生成」生成影片
- 預期行為：
  - 所有步驟正常進行
  - 編輯的旁白被保存並用於生成
  - 最終生成的影片使用編輯後的旁白

**測試場景 2：多場景旁白編輯**
- 操作：
  1. 生成包含 3+ 個場景的故事
  2. 編輯第一個場景的旁白
  3. 編輯第二個場景的旁白
  4. 重新生成第三個場景的旁白
  5. 保存所有編輯
- 預期行為：
  - 各場景的編輯獨立進行
  - 所有編輯被正確保存
  - 生成影片時使用所有編輯後的旁白

### 3. 數據流測試

#### 3.1 旁白數據結構驗證

**測試場景 1：narrationSegments 結構驗證**
- 驗證數據結構：
  ```json
  {
    "narrationSegments": [
      {
        "segmentId": 1,
        "text": "旁白文字"
      }
    ]
  }
  ```
- 預期行為：
  - 所有字段都存在且類型正確
  - segmentId 是遞增的整數
  - text 是非空字符串

#### 3.2 數據持久化測試

**測試場景 1：編輯後的旁白被正確保存**
- 操作：
  1. 編輯旁白並保存
  2. 刷新頁面
  3. 驗證編輯是否被保留
- 預期行為：
  - 編輯的旁白被保存到內存存儲或數據庫
  - 刷新後數據仍然存在

### 4. 錯誤處理測試

#### 4.1 API 錯誤處理

**測試場景 1：網絡錯誤**
- 操作：
  1. 在重新生成旁白時模擬網絡錯誤
- 預期行為：
  - 顯示錯誤提示信息
  - 用戶可以重試

**測試場景 2：API 超時**
- 操作：
  1. 在重新生成旁白時模擬超時
- 預期行為：
  - 顯示超時提示信息
  - 用戶可以重試

#### 4.2 用戶輸入驗證

**測試場景 1：無效的旁白文本**
- 操作：
  1. 輸入空文本或僅包含空格的文本
  2. 嘗試保存
- 預期行為：
  - 顯示驗證錯誤
  - 保存被阻止

## 測試工具和環境

- 前端測試：React Testing Library + Vitest
- API 測試：Postman 或 curl
- 集成測試：Playwright 或 Cypress
- 環境：開發環境 + 測試環境

## 測試執行計劃

1. **單元測試**（優先級：高）
   - 測試 `regenerateNarrationSegments` 函數
   - 測試 `NarrationScriptEditor` 組件

2. **集成測試**（優先級：高）
   - 測試前後端集成
   - 測試完整工作流程

3. **端到端測試**（優先級：中）
   - 測試完整的用戶交互流程
   - 測試多場景場景

4. **性能測試**（優先級：低）
   - 測試大量旁白片段的渲染性能
   - 測試 API 響應時間

## 測試成功標準

- ✅ 所有單元測試通過
- ✅ 所有集成測試通過
- ✅ 所有端到端測試通過
- ✅ 沒有控制台錯誤或警告
- ✅ 用戶界面響應流暢
- ✅ 所有錯誤情況都被正確處理

## 已知問題和限制

1. TTS API 可能有延遲，需要優化
2. 大量旁白片段可能影響性能
3. 某些語言的旁白生成質量可能不同

## 後續改進建議

1. 實現旁白片段的拖拽排序
2. 支持批量編輯旁白
3. 添加旁白預覽（文字轉語音）
4. 支持多語言旁白混合
5. 實現旁白模板庫
